<script>
const display = document.getElementById('display');
const historyPreview = document.getElementById('historyPreview');
const historyList = document.getElementById('historyList');
const mobileHistoryList = document.getElementById('mobileHistoryList');
let isDegrees = true;
let lastResult = 0;

// Input Handling
function input(value) {
    if (display.value === 'Error' || display.value === 'Invalid Input') display.value = '';

    const lastChar = display.value.slice(-1);
    const operators = ['+', '-', '*', '/', '^', '%', '.'];

    // Prevent multiple operators in a row
    if (operators.includes(lastChar) && operators.includes(value)) return;

    // Prevent leading invalid operators
    if (display.value === '' && ['+', '*', '/', '^', '%', ')'].includes(value)) return;

    display.value += value;
    scrollDisplayEnd();
}

function inputFunc(func) {
    if (display.value === 'Error' || display.value === 'Invalid Input') display.value = '';
    display.value += func + '(';
    scrollDisplayEnd();
}

function deleteChar() {
    if (display.value === 'Error' || display.value === 'Invalid Input') {
        display.value = '';
    } else {
        display.value = display.value.slice(0, -1);
    }
}

function clearDisplay() {
    display.value = '';
    historyPreview.innerText = '';
}

function scrollDisplayEnd() {
    display.scrollLeft = display.scrollWidth;
}

// Mode Toggle
function setMode(mode) {
    const degBtn = document.getElementById('degBtn');
    const radBtn = document.getElementById('radBtn');

    if (mode === 'deg') {
        isDegrees = true;
        degBtn.classList.add('bg-blue-600', 'text-white');
        radBtn.classList.remove('bg-blue-600', 'text-white');
        radBtn.classList.add('text-slate-400', 'hover:text-white');
    } else {
        isDegrees = false;
        radBtn.classList.add('bg-blue-600', 'text-white');
        degBtn.classList.remove('bg-blue-600', 'text-white');
        degBtn.classList.add('text-slate-400', 'hover:text-white');
    }
}

// Core Calculation Logic
function calculate() {
    if (display.value.trim() === '') return;

    let expression = display.value;
    let displayExpression = expression;

    // Quick sanity checks
    if (/[\+\-\*\/\^\.%]$/.test(expression)) {
        showError("Invalid Input");
        return;
    }
    if ((expression.match(/\(/g) || []).length !== (expression.match(/\)/g) || []).length) {
        showError("Invalid Input");
        return;
    }

    // Replace constants
    expression = expression.replace(/Ï€/g, 'Math.PI');
    expression = expression.replace(/e/g, 'Math.E');

    // Replace power operator ^
    expression = expression.replace(/\^/g, '**');

    // Replace percentage
    expression = expression.replace(/%/g, '/100');

    // Replace trigonometric functions
    expression = expression.replace(/sin\(/g, `Math.sin(${isDegrees ? 'Math.PI/180*' : ''}`);
    expression = expression.replace(/cos\(/g, `Math.cos(${isDegrees ? 'Math.PI/180*' : ''}`);
    expression = expression.replace(/tan\(/g, `Math.tan(${isDegrees ? 'Math.PI/180*' : ''}`);

    // Logarithmic and sqrt
    expression = expression.replace(/log\(/g, 'Math.log10(');
    expression = expression.replace(/ln\(/g, 'Math.log(');
    expression = expression.replace(/sqrt\(/g, 'Math.sqrt(');

    try {
        const result = new Function('return ' + expression)();

        if (!isFinite(result) || isNaN(result)) throw new Error();

        const formattedResult = parseFloat(result.toFixed(8));

        historyPreview.innerText = display.value + ' =';
        display.value = formattedResult;
        addToHistory(displayExpression, formattedResult);
        lastResult = formattedResult;

    } catch (error) {
        showError("Invalid Input");
    }
}

// Show Error Gracefully
function showError(msg) {
    display.value = msg;
    setTimeout(() => {
        if (display.value === msg) display.value = '';
    }, 1500);
}

// History
function addToHistory(expr, res) {
    const itemHTML = `
        <div class="bg-slate-800 p-3 rounded border border-slate-700 hover:border-slate-600 transition-colors cursor-pointer" onclick="loadHistory('${res}')">
            <div class="text-slate-400 text-xs mb-1 text-right font-mono">${expr}</div>
            <div class="text-white font-bold text-right font-mono text-lg">= ${res}</div>
        </div>
    `;

    if (historyList.children[0] && historyList.children[0].innerText.includes("No calculations")) {
        historyList.innerHTML = '';
        mobileHistoryList.innerHTML = '';
    }

    historyList.insertAdjacentHTML('afterbegin', itemHTML);
    mobileHistoryList.insertAdjacentHTML('afterbegin', itemHTML);
}

function loadHistory(val) {
    display.value += val;
}

function clearHistory() {
    const emptyMsg = '<div class="text-slate-600 text-sm italic text-center mt-4">No calculations yet</div>';
    historyList.innerHTML = emptyMsg;
    mobileHistoryList.innerHTML = emptyMsg;
}

// Keyboard Support
document.addEventListener('keydown', (e) => {
    const key = e.key;

    if (/[0-9+\-*/.%^()]/.test(key)) {
        input(key);
    } else if (key === 'Enter') {
        e.preventDefault();
        calculate();
    } else if (key === 'Backspace') {
        deleteChar();
    } else if (key === 'Escape') {
        clearDisplay();
    }
});
</script>
